// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 사용자 목표 설정 (앱 초기 세팅값)
model UserConfig {
  id          Int      @id @default(autoincrement())
  startWeight Float    // 시작 체중 (101.1kg)
  goalWeight  Float    // 목표 체중 (85.0kg)
  startDate   DateTime @default(now()) @db.Timestamptz // 프로젝트 시작일
}

// 일일 기록 (Log)
model DailyLog {
  id          Int      @id @default(autoincrement())
  date        DateTime @unique @default(now()) @db.Timestamptz // 날짜 (YYYY-MM-DD)
  weight      Float?   // 당일 체중

  // 퀘스트 달성 여부
  proteinAmount Int     @default(0)     // 섭취한 단백질 총량(g)
  waterDone     Boolean @default(false) // 물 3L 달성 여부
  cleanDiet     Boolean @default(false) // 야식 금지 달성 여부

  // 운동 기록
  workoutDone   Boolean @default(false) // 운동 완료 여부
  workoutPart   String? // 그날의 운동 부위 (예: 등/이두)
  workoutTime   DateTime? @db.Timestamptz // 운동 완료 시간 (얼리버드/나이트오울 체크용)
  memo          String? @db.Text // 간단 메모

  // 게이미피케이션
  xpEarned      Int     @default(0) // 이 날 획득한 XP
  streakFrozen  Boolean @default(false) // 프리즈 사용 여부
}

// ============================================
// 게이미피케이션 시스템
// ============================================

// 사용자 게이미피케이션 프로필
model UserGamification {
  id              Int       @id @default(autoincrement())
  totalXP         Int       @default(0)        // 총 누적 XP
  currentLevel    Int       @default(1)        // 현재 레벨 (1-100)
  streakFreezes   Int       @default(0)        // 보유 스트릭 프리즈 토큰
  streakFreezesUsed Int     @default(0)        // 사용한 프리즈 총 횟수
  createdAt       DateTime  @default(now()) @db.Timestamptz
  updatedAt       DateTime  @updatedAt @db.Timestamptz
}

// 업적/뱃지 정의
model Achievement {
  id              Int       @id @default(autoincrement())
  key             String    @unique           // e.g., "first_workout", "streak_7"
  nameKo          String                      // 한국어 이름
  descriptionKo   String                      // 한국어 설명
  iconEmoji       String                      // 이모지 아이콘
  category        String                      // "workout", "streak", "quest", "special"
  tier            String    @default("bronze") // bronze, silver, gold, platinum
  xpReward        Int       @default(0)       // 달성 시 XP 보상
  requirement     Int       @default(1)       // 달성 조건 수치
  freezeReward    Int       @default(0)       // 달성 시 프리즈 토큰 보상
  createdAt       DateTime  @default(now()) @db.Timestamptz

  userAchievements UserAchievement[]
}

// 사용자가 달성한 업적
model UserAchievement {
  id              Int       @id @default(autoincrement())
  achievementId   Int
  achievement     Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt      DateTime  @default(now()) @db.Timestamptz
  notified        Boolean   @default(false)   // 언락 애니메이션 표시 여부

  @@unique([achievementId])
}

// 주간/월간 챌린지 정의
model Challenge {
  id              Int       @id @default(autoincrement())
  key             String    @unique
  nameKo          String
  descriptionKo   String
  type            String                      // "weekly", "monthly"
  category        String                      // "workout", "quest", "streak", "mixed"
  targetValue     Int                         // 목표 수치
  xpReward        Int
  startDate       DateTime  @db.Timestamptz
  endDate         DateTime  @db.Timestamptz
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now()) @db.Timestamptz

  userChallenges  UserChallenge[]
}

// 사용자의 챌린지 진행 상황
model UserChallenge {
  id              Int       @id @default(autoincrement())
  challengeId     Int
  challenge       Challenge @relation(fields: [challengeId], references: [id])
  currentValue    Int       @default(0)       // 현재 진행도
  completed       Boolean   @default(false)
  completedAt     DateTime? @db.Timestamptz
  claimed         Boolean   @default(false)   // XP 수령 여부
  createdAt       DateTime  @default(now()) @db.Timestamptz

  @@unique([challengeId])
}

// XP 트랜잭션 로그
model XPTransaction {
  id              Int       @id @default(autoincrement())
  amount          Int                         // 획득 XP
  source          String                      // "workout", "streak", "quest", "challenge", "achievement"
  sourceId        String?                     // 관련 엔티티 ID
  description     String?                     // 설명
  createdAt       DateTime  @default(now()) @db.Timestamptz
}

// 스트릭 프리즈 사용 로그
model StreakFreezeLog {
  id              Int       @id @default(autoincrement())
  usedAt          DateTime  @default(now()) @db.Timestamptz
  savedStreak     Int                         // 프리즈로 지킨 스트릭 수
}

// ============================================
// 기존 모델
// ============================================

// 인바디 측정 기록 (주간)
model InBodyRecord {
  id              Int      @id @default(autoincrement())
  date            DateTime @default(now()) @db.Timestamptz // 측정 날짜
  imagePath       String   // 업로드된 이미지 경로

  // 기본 체성분
  weight          Float    // 체중 (kg)
  skeletalMuscle  Float    // 골격근량 (kg)
  bodyFatMass     Float    // 체지방량 (kg)
  bodyFatPercent  Float    // 체지방률 (%)

  // 비만 지표
  bmi             Float    // BMI
  visceralFat     Int      // 내장지방 레벨

  // 인바디 점수 및 기타
  inbodyScore     Int      // 인바디 점수 (0-100)
  bmr             Int      // 기초대사량 (kcal)

  // 체수분, 단백질, 무기질
  bodyWater       Float?   // 체수분 (L)
  protein         Float?   // 단백질 (kg)
  minerals        Float?   // 무기질 (kg)

  // 부위별 근육 분석 (JSON 문자열로 저장)
  segmentalMuscle String?  @db.Text // {"leftArm": "표준", "rightArm": "표준", ...}
  segmentalFat    String?  @db.Text // {"leftArm": "표준이상", ...}

  // AI 분석 결과
  aiAnalysis      String?  @db.Text // AI가 생성한 분석 및 조언 (JSON)

  createdAt       DateTime @default(now()) @db.Timestamptz
}
